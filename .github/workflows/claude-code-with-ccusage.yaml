name: Claude Code with ccusage

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '24'

      - name: detect model
        id: detect-model
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            BODY=$(cat <<'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            BODY=$(cat <<'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            BODY=$(cat <<'EOF'
          ${{ github.event.review.body }}
          EOF
          )
          elif [ "${{ github.event_name }}" = "issues" ]; then
            BODY=$(cat <<'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          fi

          BODY_LOWER=$(echo "$BODY" | tr '[:upper:]' '[:lower:]')

          if echo "$BODY_LOWER" | grep -q '\bopus\b'; then
            MODEL="opus"
          else
            # Default to sonnet
            MODEL="sonnet"
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Selected model: $MODEL"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@8a1c4371755898f67cd97006ba7c97702d5fc4bf # v1.0.16
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --system-prompt "全ての応答は日本語で行うこと"
            --allowedTools "Bash(npm:*),Bash(node --version)"
            --model ${{ steps.detect-model.outputs.model }}
          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

      - name: Report usage cost
        run: |
          mkdir -p out
          npx ccusage@18.0.5 > out/ccusage.txt || true
          npx ccusage@18.0.5 --json > out/ccusage.json || true
          {
            echo "## Claude Code usage / cost (ccusage)"
            echo ""
            echo "**Run:** $GITHUB_WORKFLOW / $GITHUB_RUN_ID"
            echo ""
            echo "### ccusage (text)"
            echo '```'
            (cat out/ccusage.txt 2>/dev/null || echo "ccusage.txt not found")
            echo '```'
            echo ""
            echo "### ccusage (json)"
            echo '```json'
            (cat out/ccusage.json 2>/dev/null || echo "{}")
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
